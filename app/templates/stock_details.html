<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ data.symbol }} Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
</head>

<body>
    <canvas id="matrixCanvas" aria-hidden="true"></canvas>
    <h1>{{ data.symbol }} - {{ data.name }}</h1>

    <!-- Section: Company Information -->
    <h2>Company Information</h2>
    <table>
        <tr>
            <th>Description</th>
            <td>{{ data.description }}</td>
        </tr>
        <tr>
            <th>Sector</th>
            <td>{{ data.sector }}</td>
        </tr>
        <tr>
            <th>Industry</th>
            <td>{{ data.industry }}</td>
        </tr>
        <tr>
            <th>IPO Date</th>
            <td>{{ data.ipo_date }}</td>
        </tr>
        <tr>
            <th>Website</th>
            <td><a href="{{ data.website }}" target="_blank">{{ data.website }}</a></td>
        </tr>
    </table>

    <!-- Section: Current Quote -->
    <h2>Current Quote</h2>
    <table class="quote-table">
        <tr>
            <th>Exchange</th>
            <td>{{ data.exchange }}</td>
        </tr>
        <tr>
            <th>Current Price</th>
            <td>{{ data.current_price }}</td>
        </tr>
        <tr>
            <th>Bid Price</th>
            <td>{{ data.bid_price }}</td>
        </tr>
        <tr>
            <th>Ask Price</th>
            <td>{{ data.ask_price }}</td>
        </tr>
        <tr>
            <th>Market Cap</th>
            <td>{{ data.market_cap }}</td>
        </tr>
        <tr>
            <th>P/E Ratio</th>
            <td>{{ data.pe_ratio }}</td>
        </tr>
        <tr>
            <th>Volume</th>
            <td>{{ data.volume }}</td>
        </tr>
        <tr>
            <th>Latest Trade Price</th>
            <td>{{ data.latest_trade_price }}</td>
        </tr>
        <tr>
            <th>52-Week High</th>
            <td>{{ data.fifty_two_week_high }}</td>
        </tr>
        <tr>
            <th>52-Week Low</th>
            <td>{{ data.fifty_two_week_low }}</td>
        </tr>
        <tr>
            <th>Dividend Yield</th>
            <td>{{ data.dividend_yield }}%</td>
        </tr>
        <tr>
            <th>Earnings Per Share (EPS)</th>
            <td>{{ data.eps }}</td>
        </tr>
        <tr>
            <th>Beta</th>
            <td>{{ data.beta }}</td>
        </tr>
    </table>

    <!-- Section: Financials -->
    <h2>Key Financials</h2>
    {% if data.financials %}
    <h3>Income Statement (Latest Year)</h3>
    <table>
        {% for key, value in data.financials.income_statement.items() %}
        <tr>
            <th>{{ key }}</th>
            <td>{{ value }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>Balance Sheet (Latest)</h3>
    <table>
        {% for key, value in data.financials.balance_sheet.items() %}
        <tr>
            <th>{{ key }}</th>
            <td>{{ value }}</td>
        </tr>
        {% endfor %}
    </table>

    <h3>Cash Flow (Latest Year)</h3>
    <table>
        {% for key, value in data.financials.cash_flow.items() %}
        <tr>
            <th>{{ key }}</th>
            <td>{{ value }}</td>
        </tr>
        {% endfor %}
    </table>
    {% else %}
    <p>No financial data available.</p>
    {% endif %}

    <!-- Section: Historical Chart -->
    <h2>Historical Price Chart (1 Year)</h2>
    {% if data.history_chart %}
    <img src="data:image/png;base64,{{ data.history_chart }}" alt="Historical Price Chart" class="chart">
    {% else %}
    <p>Chart not available.</p>
    {% endif %}

    <!-- Section: News Highlights -->
    <h2>Recent News</h2>
    {% if data.news %}
    <ul class="news">
        {% for item in data.news %}
        <li>
            <a href="{{ item.link }}" target="_blank">{{ item.title }}</a><br>
            <small>{{ item.publisher }} - {{ item.published_at }}</small><br>
            {{ item.summary }}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No recent news available.</p>
    {% endif %}

    <!-- Section: Analysis and Recommendation -->
    <h2>Stock Analysis</h2>
    <table>
        <tr>
            <th>Current Price</th>
            <td>{{ data.current_price }}</td>
        </tr>
        <tr>
            <th>Estimated Intrinsic Value (Graham Formula)</th>
            <td>{{ data.intrinsic_value }}</td>
        </tr>
        <tr>
            <th>Price Difference</th>
            <td class="{% if data.price_difference|int > 0 %}positive{% else %}negative{% endif %}">{{ data.price_difference }} ({{
                data.percentage_difference }}%)</td>
        </tr>
    </table>
    <div class="recommendation {{ data.recommendation.lower() }}">
        Recommendation: {{ data.recommendation.upper() }}
        {% if data.recommendation == 'buy' %}
        - The stock appears undervalued.
        {% elif data.recommendation == 'sell' %}
        - The stock appears overvalued.
        {% else %}
        - The stock is fairly valued.
        {% endif %}
    </div>

    <h3>Intrinsic Value vs. Price Chart</h3>
    {% if data.analysis_chart %}
    <img src="data:image/png;base64,{{ data.analysis_chart }}" alt="Intrinsic Value Chart" class="chart">
    {% else %}
    <p>Analysis chart not available.</p>
    {% endif %}

    <!-- Additional Analysis: Technical Indicators -->
    <h2>Technical Indicators</h2>
    <table>
        <tr>
            <th>50-Day Moving Average</th>
            <td>{{ data.ma_50 }}</td>
        </tr>
        <tr>
            <th>200-Day Moving Average</th>
            <td>{{ data.ma_200 }}</td>
        </tr>
        <tr>
            <th>RSI (14-Day)</th>
            <td>{{ data.rsi }} {% if data.rsi < 30 %}(Oversold){% elif data.rsi> 70 %}(Overbought){% endif %}</td>
        </tr>
    </table>
<footer class="footer">
    <div class="footer-container">
        <div class="quick-links">
            <h3>Quick Links</h3>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/all_stocks">Stocks</a></li>
            </ul>
        </div>
        <div class="social">
            <h3>Follow us on</h3>
            <ul>
                <li>
                    <a href="https://github.com/metacoder87">
                        <i class="fab fa-github"></i>
                    </a>
                </li>
                <li>
                    <a href="https://stackoverflow.com/users/8031257/metag">
                        <i class="fab fa-stack-overflow"></i>
                    </a>
                </li>
                <li><a href="https://www.linkedin.com/company/g-m-cubed">
                        <i class="fab fa-linkedin"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <div id="design-tag">
        <p>Designed & Developed by</p>
        <a href="https://gmcubedesigns.com" target="_blank">
            <img src="{{ url_for('static', filename='images/gm_cubed_neon.png') }}" alt="GM Cubed Designs Logo">
        </a>

    </div>
</footer>
</body>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const canvas = document.getElementById("matrixCanvas");
        const ctx = canvas.getContext("2d");

        // Resize canvas to full window
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Matrix settings
        const fontSize = 16;
        const columns = Math.floor(canvas.width / fontSize);
        const drops = Array(columns).fill(0); // drop positions

        // Container for numbers (historic + live)
        let numberStream = [];

        // Load historic data from template context (passed in Flask)
        {% if historical_data %}
        numberStream = [
            {% for d in historical_data %}
                "{{ d['Close'] }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        {% else %}
        numberStream = [];
        {% endif %}

        // Drawing the rain
        function draw() {
            // fade effect
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#0F0"; // neon green
            ctx.font = fontSize + "px monospace";

            for (let i = 0; i < drops.length; i++) {
                // pick a number from stream or random fallback
                const text =
                    numberStream[Math.floor(Math.random() * numberStream.length)] || Math.floor(Math.random() * 1000);

                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                // reset drop randomly after it falls off screen
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }

                drops[i]++;
            }
        }

        setInterval(draw, 50);

        // Handle window resize
        window.addEventListener("resize", () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Socket.IO for live updates
        var socket = io();
        socket.on("price_update", function (data) {
            // Push latest price into stream
            if (data && data.price) {
                numberStream.push(data.price);
                if (numberStream.length > 500) {
                    numberStream.shift(); // keep it lean
                }
            }
        });
    });
</script>
</html>